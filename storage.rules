rules_version = '2';

// Firebase Storage security rules
service firebase.storage {
  match /b/{bucket}/o {
    // === REGLAS PARA AVATARES DE USUARIOS ===
    match /users/{userId}/avatar/{fileName} {
      // Permitir lectura pública de avatares
      allow read: if true;
      
      // Solo el propietario puede subir/actualizar/eliminar su avatar
      allow write: if request.auth != null && 
                   request.auth.uid == userId &&
                   isValidImageFile(fileName) &&
                   isValidFileSize(request.resource);
    }
    
    // === REGLAS PARA IMÁGENES DE TARJETAS ===
    match /cards/{cardId}/images/{fileName} {
      // Permitir lectura pública de imágenes de tarjetas
      allow read: if true;
      
      // CRÍTICO: Verificar que el usuario es propietario de la tarjeta
      allow write: if request.auth != null &&
                   isCardOwner(cardId, request.auth.uid) &&
                   isValidImageFile(fileName) &&
                   isValidFileSize(request.resource);
    }
    
    // === REGLAS PARA LOGOS DE TARJETAS ===
    match /cards/{cardId}/logo/{fileName} {
      // Permitir lectura pública de logos
      allow read: if true;
      
      // CRÍTICO: Verificar que el usuario es propietario de la tarjeta
      allow write: if request.auth != null &&
                   isCardOwner(cardId, request.auth.uid) &&
                   isValidImageFile(fileName) &&
                   isValidFileSize(request.resource);
    }
    
    // === REGLAS PARA PORTFOLIO DE TARJETAS (SIMPLIFICADO Y FLEXIBLE) ===
    // Soporta tanto estructura simple como con subcarpetas
    match /cards/{cardId}/portfolio/{allPaths=**} {
      // Permitir lectura pública
      allow read: if true;
      
      // Solo requerir autenticación - MUY PERMISIVO PARA DEBUGGING
      allow write: if request.auth != null;
    }
    
    // === REGLAS PARA COVER DE TARJETAS ===
    match /cards/{cardId}/cover/{fileName} {
      // Permitir lectura pública de imágenes de cover
      allow read: if true;
      
      // CRÍTICO: Verificar que el usuario es propietario de la tarjeta
      allow write: if request.auth != null &&
                   isCardOwner(cardId, request.auth.uid) &&
                   isValidImageFile(fileName) &&
                   isValidImageSize(request.resource);
    }
    
    // === REGLAS PARA AVATAR DE TARJETAS ===
    match /cards/{cardId}/avatar/{fileName} {
      // Permitir lectura pública de avatares de tarjetas
      allow read: if true;
      
      // CRÍTICO: Verificar que el usuario es propietario de la tarjeta
      allow write: if request.auth != null &&
                   isCardOwner(cardId, request.auth.uid) &&
                   isValidImageFile(fileName) &&
                   isValidImageSize(request.resource);
    }
    
    // === REGLAS PARA PRODUCTOS ===
    match /products/{productId}/images/{fileName} {
      // Permitir lectura pública de imágenes de productos
      allow read: if true;
      
      // REGLA SIMPLIFICADA: Solo verificar que el usuario esté autenticado
      allow write: if request.auth != null &&
                   isValidImageFile(fileName) &&
                   isValidFileSize(request.resource);
    }
    
    // === REGLAS PARA DOCUMENTOS Y ARCHIVOS PRIVADOS ===
    match /users/{userId}/documents/{fileName} {
      // Solo el propietario puede leer sus documentos
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Solo el propietario puede subir/actualizar/eliminar documentos
      allow write: if request.auth != null && 
                   request.auth.uid == userId &&
                   isValidDocumentFile(fileName) &&
                   isValidFileSize(request.resource);
    }
    
    // === REGLAS PARA ARCHIVOS TEMPORALES ===
    match /temp/{userId}/{fileName} {
      // Solo el propietario puede leer archivos temporales
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Solo el propietario puede subir archivos temporales
      allow write: if request.auth != null && 
                   request.auth.uid == userId &&
                   isValidFileSize(request.resource);
    }
    
    // === REGLAS PARA CALENDARIO COLABORATIVO ===
    
    // Fotos de perfil de profesionales del calendario (legacy path)
    // SIMPLIFICADO: Solo requiere autenticación
    match /calendar/professionals/{professionalId}/avatar/{fileName} {
      // Permitir lectura pública de avatares de profesionales
      allow read: if true;
      
      // Solo requiere autenticación - SIMPLIFICADO
      allow write: if request.auth != null &&
                   isValidImageFile(fileName) &&
                   isValidImageSize(request.resource);
    }

    // Fotos de perfil de profesionales del calendario (estructura actual)
    // SIMPLIFICADO: Solo requiere autenticación para debugging
    match /calendars/{calendarId}/professionals/{fileName} {
      // Permitir lectura pública para que los profesionales y clientes vean el avatar
      allow read: if true;

      // Solo requiere autenticación - MUY PERMISIVO PARA PERMITIR SUBIDA
      allow write: if request.auth != null &&
                   isValidImageFile(fileName) &&
                   isValidImageSize(request.resource);
    }
    
    // Adjuntos de eventos del calendario
    match /calendar/events/{eventId}/attachments/{fileName} {
      // Solo miembros del calendario pueden leer adjuntos
      allow read: if request.auth != null &&
                 canAccessEvent(eventId, request.auth.uid);
      
      // Solo miembros del calendario pueden subir adjuntos
      allow write: if request.auth != null &&
                  canAccessEvent(eventId, request.auth.uid) &&
                  isValidFileSize(request.resource);
    }

    // === FUNCIONES DE VALIDACIÓN ===
    
    // Función crítica: Verificar que el usuario es propietario de la tarjeta
    function isCardOwner(cardId, userId) {
      return firestore.get(/databases/(default)/documents/cards/$(cardId)).data.userId == userId;
    }
    
    // Verificar si el usuario puede acceder a un evento
    function canAccessEvent(eventId, userId) {
      let eventDoc = firestore.get(/databases/(default)/documents/calendar_events/$(eventId));
      let calendarDoc = firestore.get(/databases/(default)/documents/shared_calendars/$(eventDoc.data.calendarId));
      // Verificar si el userId está en la lista de miembros
      return calendarDoc.data.ownerId == userId ||
             eventDoc.data.createdBy == userId ||
             userId in calendarDoc.data.members;
    }
    
    // Validar tipos de archivos de imagen
    function isValidImageFile(fileName) {
      return fileName.matches('.*\\.(jpg|jpeg|png|gif|webp|svg)$') &&
             fileName.size() <= 255;
    }
    
    // Validar tipos de archivos de documento
    function isValidDocumentFile(fileName) {
      return fileName.matches('.*\\.(pdf|doc|docx|txt|csv|xls|xlsx)$') &&
             fileName.size() <= 255;
    }
    
    // Validar tamaño de archivo
    function isValidFileSize(resource) {
      return resource.size < 10 * 1024 * 1024; // 10MB límite
    }
    
    // Validar tamaño de archivo para imágenes
    function isValidImageSize(resource) {
      return resource.size < 5 * 1024 * 1024; // 5MB límite para imágenes
    }
  }
}
